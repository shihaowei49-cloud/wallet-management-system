#!/usr/bin/expect -f

set timeout 60
set server_ip "43.133.241.218"
set username "administrator"
set password "Helen123!@#"

puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸ” SSHè¿æ¥æµ‹è¯•å·¥å…·"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

puts "ç›®æ ‡æœåŠ¡å™¨: $server_ip"
puts "ç”¨æˆ·å: $username"
puts "è¿æ¥ä¸­...\n"

# å°è¯•è¿æ¥
spawn ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $username@$server_ip

# æ•è·è¾“å‡ºå¹¶å¤„ç†
expect {
    "*yes/no*" {
        puts "âœ“ æ”¶åˆ°å¯†é’¥ç¡®è®¤æç¤º"
        send "yes\r"
        exp_continue
    }
    "*assword:" {
        puts "âœ“ æ”¶åˆ°å¯†ç æç¤º"
        send "$password\r"

        expect {
            "*administrator@*" {
                puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                puts "âœ… SSHè¿æ¥æˆåŠŸï¼"
                puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

                # æ£€æŸ¥ç³»ç»Ÿç±»å‹
                puts "ğŸ“‹ æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨ä¿¡æ¯...\n"

                send "uname -a 2>/dev/null || ver\r"
                expect "*administrator@*"

                send "cat /etc/os-release 2>/dev/null | grep PRETTY_NAME || echo 'Windowsç³»ç»Ÿ'\r"
                expect "*administrator@*"

                send "whoami\r"
                expect "*administrator@*"

                send "pwd\r"
                expect "*administrator@*"

                puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                puts "âœ… æœåŠ¡å™¨å¯ä»¥æ­£å¸¸è¿æ¥ï¼"
                puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                puts "ç°åœ¨æ‚¨å¯ä»¥è¿è¡Œéƒ¨ç½²å‘½ä»¤äº†ã€‚"
                puts "æ˜¯å¦ç«‹å³éƒ¨ç½²ï¼Ÿ(æŒ‰ Ctrl+C é€€å‡ºï¼Œæˆ–ç­‰å¾…è‡ªåŠ¨éƒ¨ç½²)\n"

                sleep 3

                puts "å¼€å§‹è‡ªåŠ¨éƒ¨ç½²...\n"
                send "curl -fsSL https://raw.githubusercontent.com/shihaowei49-cloud/wallet-management-system/main/è‡ªåŠ¨æ‹‰å–éƒ¨ç½².sh | sudo bash\r"

                expect {
                    "*password*" {
                        send "$password\r"
                    }
                }

                # ç­‰å¾…éƒ¨ç½²å®Œæˆ
                set timeout 600
                expect {
                    "*éƒ¨ç½²å®Œæˆ*" {
                        puts "\nâœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
                    }
                    timeout {
                        puts "\nâ± éƒ¨ç½²è¶…æ—¶ï¼Œä½†å¯èƒ½ä»åœ¨è¿›è¡Œä¸­"
                    }
                }

                send "exit\r"
                expect eof
            }
            "*Permission denied*" {
                puts "\nâŒ å¯†ç é”™è¯¯æˆ–æƒé™è¢«æ‹’ç»"
                exit 1
            }
            timeout {
                puts "\nâŒ ç™»å½•è¶…æ—¶"
                exit 1
            }
        }
    }
    "*Permission denied*" {
        puts "\nâŒ è¿æ¥è¢«æ‹’ç»ï¼ˆå¯†é’¥æˆ–å¯†ç é—®é¢˜ï¼‰"
        exit 1
    }
    "*Connection refused*" {
        puts "\nâŒ è¿æ¥è¢«æ‹’ç»ï¼ˆç«¯å£æœªå¼€æ”¾æˆ–æœåŠ¡æœªå¯åŠ¨ï¼‰"
        exit 1
    }
    "*Connection timed out*" {
        puts "\nâŒ è¿æ¥è¶…æ—¶ï¼ˆç½‘ç»œé—®é¢˜æˆ–é˜²ç«å¢™é˜»æ­¢ï¼‰"
        exit 1
    }
    "*Connection reset*" {
        puts "\nâŒ è¿æ¥è¢«é‡ç½®"
        puts "\nå¯èƒ½åŸå› ï¼š"
        puts "1. SSHæœåŠ¡é…ç½®é—®é¢˜"
        puts "2. è¾¾åˆ°æœ€å¤§è¿æ¥æ•°é™åˆ¶"
        puts "3. é˜²ç«å¢™è§„åˆ™é™åˆ¶"
        puts "\nå»ºè®®ï¼š"
        puts "1. æ£€æŸ¥è…¾è®¯äº‘å®‰å…¨ç»„æ˜¯å¦å…è®¸æ‚¨çš„IPè®¿é—®"
        puts "2. å°è¯•ä½¿ç”¨è…¾è®¯äº‘Webæ§åˆ¶å°ç™»å½•"
        puts "3. æ£€æŸ¥SSHæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ"
        exit 1
    }
    timeout {
        puts "\nâŒ è¿æ¥è¶…æ—¶ï¼ˆ60ç§’ï¼‰"
        puts "\nè¿™é€šå¸¸æ˜¯å› ä¸ºï¼š"
        puts "1. æœåŠ¡å™¨SSHæœåŠ¡å“åº”æ…¢"
        puts "2. ç½‘ç»œè¿æ¥ä¸ç¨³å®š"
        puts "3. é˜²ç«å¢™ç­–ç•¥é™åˆ¶"
        exit 1
    }
    eof {
        puts "\nâŒ è¿æ¥æ„å¤–æ–­å¼€"
        exit 1
    }
}
